#!/usr/sbin/nft -f

flush ruleset

# Define our endpoints
define BUILDER_ENDPOINT = 0.0.0.0     # Replace with actual builder endpoint IP

table inet filter {
    chain input {
        type filter hook input priority 0; policy drop

        # Allow established/related connections
        ct state established,related accept

        # Maintenance mode SSH access
        tcp dport 22 accept comment "SSH"

        # Allow only builder endpoint connections to these ports
        ip saddr $BUILDER_ENDPOINT tcp dport 9000 accept comment "FB-operated Consensus Client P2P"
        ip saddr $BUILDER_ENDPOINT tcp dport 30303 accept comment "FB-operated Execution Client P2P"
        ip saddr $BUILDER_ENDPOINT tcp dport 27017 accept comment "Authenticated Searcher Input Channel"

        # Allow traffic on veth interface
        iifname "veth0" accept comment "Searcher network interface"
    }

    chain output {
        type filter hook output priority 0; policy accept
    }
}

#!/bin/sh
### BEGIN INIT INFO
# Provides:          searcher-container
# Required-Start:    $network
# Required-Stop:     $network
# Default-Start:     2 3 4 5
# Default-Stop:      0 1 6
# Short-Description: Searcher SSH Container
# Description:       Starts a simple SSH container using podman
### END INIT INFO

DAEMON=/usr/bin/podman
USER=searcher
NAME=searcher-container
SEARCHER_SSH_PORT=10022
FLASHBOTS_BUILDER_STATE_DIFF_PORT=8547
TITAN_BUILDER_STATE_DIFF_PORT=8548
IPTABLES="/usr/sbin/iptables"

case "$1" in
    start)

        # -p ${TITAN_BUILDER_STATE_DIFF_PORT}:${TITAN_BUILDER_STATE_DIFF_PORT} \
        
        echo "Starting $NAME..."
        su -s /bin/sh $USER -c "cd ~ && $DAEMON run -d \
            --name $NAME \
            -p ${SEARCHER_SSH_PORT}:22 \
            -p ${FLASHBOTS_BUILDER_STATE_DIFF_PORT}:${FLASHBOTS_BUILDER_STATE_DIFF_PORT} \
            -v /etc/searcher_key:/container_auth_keys:ro \
            -v /persistent:/persistent \
            docker.io/library/ubuntu:24.04 \
            /bin/sh -c ' \
                DEBIAN_FRONTEND=noninteractive apt-get update && \
                DEBIAN_FRONTEND=noninteractive apt-get install -y openssh-server && \
                mkdir -p /run/sshd && \
                mkdir -p /root/.ssh && \
                cp /container_auth_keys /root/.ssh/authorized_keys && \
                chmod 700 /root/.ssh && \
                chmod 600 /root/.ssh/authorized_keys && \
                /usr/sbin/sshd -D -e'"
        
        ;;
    stop)
        echo "Stopping $NAME..."
        su -s /bin/sh $USER -c "cd ~ && $DAEMON stop $NAME"
        su -s /bin/sh $USER -c "cd ~ && $DAEMON rm -f $NAME"
        ;;
    status)
        if su -s /bin/sh $USER -c "cd ~ && $DAEMON container exists $NAME"; then
            echo "$NAME is running"
            su -s /bin/sh $USER -c "cd ~ && $DAEMON ps"
            exit 0
        else
            echo "$NAME is not running"
            exit 1
        fi
        ;;
    *)
        echo "Usage: $0 {start|stop|status}"
        exit 1
        ;;
esac

exit 0